<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serveredge â€” FY2026 Sales Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCLY-DmXkQIh6BNVx7KDxDYblPNbQW9YMs",
    authDomain: "serveredge-dashboard-3732a.firebaseapp.com",
    databaseURL: "https://serveredge-dashboard-3732a-default-rtdb.firebaseio.com",
    projectId: "serveredge-dashboard-3732a",
    storageBucket: "serveredge-dashboard-3732a.appspot.com",
    messagingSenderId: "387114868703",
    appId: "1:387114868703:web:b7c9580418d82262dd2e6a"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  // Expose Firebase functions to global scope
  window._fbSet    = (path, val) => set(ref(db, path), val);
  window._fbRemove = (path)      => remove(ref(db, path));
  window._fbListen = (path, cb)  => onValue(ref(db, path), snap => cb(snap.val()));

  window._fbLogin  = (email, password) => signInWithEmailAndPassword(auth, email, password);
  window._fbLogout = () => signOut(auth);

  onAuthStateChanged(auth, user => {
    if (user) {
      window._currentUser = user;
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user } }));
    } else {
      window._currentUser = null;
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user: null } }));
    }
  });

  window._fbReady = true;
  window.dispatchEvent(new Event('firebase-ready'));
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0d0d0d;
    --surface:   #141414;
    --surface2:  #1a1a1a;
    --surface3:  #222222;
    --border:    #2a2a2a;
    --green:     #6bbf33;
    --green-dk:  #4a8a1f;
    --green-dim: #1e3a0a;
    --amber:     #f5a623;
    --blue:      #4472c4;
    --text:      #e8e8e8;
    --muted:     #888;
    --faint:     #444;
    --cls1:      #4472c4;
    --cls2:      #6bbf33;
    --cls3:      #ed7d31;
    --cls4:      #9e480e;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }
  /* â”€â”€ LIGHT THEME â”€â”€ */
  body.light {
    --bg:        #f4f5f7;
    --surface:   #ffffff;
    --surface2:  #f0f1f3;
    --surface3:  #e8eaed;
    --border:    #d0d4da;
    --green:     #4a9020;
    --green-dk:  #3a7018;
    --green-dim: #d4edcc;
    --amber:     #d4870a;
    --text:      #1a1a2e;
    --muted:     #6b7280;
    --faint:     #9ca3af;
  }
  body.light .topbar { border-bottom-color: #d0d4da; }
  body.light .login-card { box-shadow: 0 4px 20px rgba(0,0,0,.12); }
  body.light .current-month-row td { background: rgba(212,135,10,.1) !important; }
  body.light .actual-input { color: #b06000 !important; }
  body.light .target-input { color: #b06000; }
  body.light .target-input.modified { color: var(--amber); }

  /* â”€â”€ THEME TOGGLE BUTTON â”€â”€ */
  .theme-toggle {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 4px 12px; cursor: pointer;
    font-family: var(--font-mono); font-size: 11px; color: var(--muted);
    transition: all .2s; display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }
  .theme-toggle:hover { border-color: var(--green); color: var(--text); }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.4;
    min-height: 100vh;
  }

  /* â”€â”€ TOP NAV â”€â”€ */
  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: #0a0a0a;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; height: 52px;
  }
  .topbar-logo {
    font-family: var(--font-head); font-weight: 800; font-size: 17px;
    color: var(--green); letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px;
  }
  .topbar-logo span { color: var(--muted); font-weight: 400; font-size: 12px; margin-left: 4px; }
  .topbar-tabs { display: flex; gap: 2px; }
  .tab-btn {
    background: none; border: none; cursor: pointer;
    padding: 6px 14px; border-radius: 6px;
    font-family: var(--font-mono); font-size: 12px; color: var(--muted);
    transition: all .15s; white-space: nowrap;
  }
  .tab-btn:hover { color: var(--text); background: var(--surface2); }
  .tab-btn.active { color: var(--green); background: var(--green-dim); border: 1px solid var(--green-dk); }
  .tab-btn .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }

  /* â”€â”€ VIEWS â”€â”€ */
  .view { display: none; padding: 20px 24px 40px; max-width: 1400px; margin: 0 auto; }
  .view.active { display: block; }

  /* â”€â”€ REP HEADER â”€â”€ */
  .rep-header {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 24px;
    margin-bottom: 18px;
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
  }
  .rep-title { font-family: var(--font-head); font-size: 22px; font-weight: 800; }
  .rep-subtitle { color: var(--muted); font-size: 11px; margin-top: 2px; }
  .rep-accent-bar { height: 3px; border-radius: 2px; width: 40px; margin-top: 6px; }

  /* â”€â”€ KPI CARDS â”€â”€ */
  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 18px; }
  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    position: relative; overflow: hidden;
  }
  .kpi-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent-color, var(--green));
  }
  .kpi-label { font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 6px; }
  .kpi-value { font-family: var(--font-head); font-size: 24px; font-weight: 800; line-height: 1; }
  .kpi-sub { font-size: 10px; color: var(--muted); margin-top: 4px; }

  /* â”€â”€ SECTION HEADERS â”€â”€ */
  .section-hdr {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-head); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: .12em; color: var(--muted);
    margin: 20px 0 10px;
  }
  .section-hdr::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ GROWTH SLIDERS â”€â”€ */
  .growth-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 18px;
  }
  .growth-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px; }
  .growth-item label {
    display: block; font-size: 10px; text-transform: uppercase; letter-spacing: .08em;
    color: var(--muted); margin-bottom: 6px;
  }
  .growth-item .growth-val {
    font-family: var(--font-head); font-size: 20px; font-weight: 800;
    margin-bottom: 6px;
  }
  .growth-item input[type=range] {
    width: 100%; height: 4px; appearance: none; background: var(--surface3);
    border-radius: 2px; outline: none; cursor: pointer;
  }
  .growth-item input[type=range]::-webkit-slider-thumb {
    appearance: none; width: 14px; height: 14px; border-radius: 50%;
    background: var(--green); cursor: pointer; border: 2px solid var(--bg);
  }

  /* â”€â”€ CHARTS ROW â”€â”€ */
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .chart-card.wide { grid-column: 1 / -1; }
  .chart-title {
    font-size: 11px; text-transform: uppercase; letter-spacing: .08em;
    color: var(--muted); margin-bottom: 12px;
  }
  .chart-wrap { position: relative; height: 200px; }
  .chart-wrap.tall { height: 240px; }

  /* â”€â”€ TRACKER TABLE â”€â”€ */
  .tracker-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 18px;
  }
  .tracker-wrap table { width: 100%; border-collapse: collapse; }
  .tracker-wrap th {
    background: var(--green-dk); color: #fff;
    font-size: 10px; text-transform: uppercase; letter-spacing: .08em;
    padding: 9px 12px; text-align: right; font-family: var(--font-mono); font-weight: 500;
  }
  .tracker-wrap th:first-child { text-align: left; }
  .tracker-wrap td {
    padding: 8px 12px; font-family: var(--font-mono); font-size: 12px;
    border-bottom: 1px solid var(--border); text-align: right;
  }
  .tracker-wrap td:first-child { text-align: left; font-weight: 500; color: var(--text); }
  .tracker-wrap tr:nth-child(even) td { background: rgba(255,255,255,.018); }
  .tracker-wrap tr:hover td { background: rgba(107,191,51,.06); }
  .tracker-wrap .total-row td {
    background: var(--green-dim) !important;
    color: var(--green); font-weight: 700; border-bottom: none;
  }
  .target-cell { color: var(--green); }
  .prev-cell   { color: #6699cc; }
  .actual-input {
    background: rgba(255,240,0,.08); border: 1px solid rgba(255,240,0,.25);
    color: #ffe566; border-radius: 4px; padding: 3px 6px;
    width: 110px; font-family: var(--font-mono); font-size: 12px; text-align: right;
    outline: none; transition: border-color .15s;
  }
  .actual-input:focus { border-color: rgba(255,240,0,.7); background: rgba(255,240,0,.14); }
  .variance-pos { color: var(--green); }
  .variance-neg { color: #e05252; }
  .status-on  { color: var(--green); font-size: 11px; }
  .status-off { color: #e05252; font-size: 11px; }
  .status-pend { color: var(--muted); font-size: 11px; }

  /* â”€â”€ CURRENT MONTH ROW â”€â”€ */
  .current-month-row td {
    background: rgba(245,166,35,.08) !important;
    border-top: 1px solid rgba(245,166,35,.4) !important;
    border-bottom: 1px solid rgba(245,166,35,.4) !important;
  }
  .current-month-badge {
    display: inline-block; font-size: 9px; background: var(--amber);
    color: #000; border-radius: 3px; padding: 1px 5px;
    font-weight: 700; margin-left: 6px; vertical-align: middle;
    text-transform: uppercase; letter-spacing: .06em;
  }

  /* â”€â”€ TARGET EDITOR â”€â”€ */
  .target-editor-tabs { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .target-editor-tab {
    padding: 5px 14px; border-radius: 5px; font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); color: var(--muted);
    font-family: var(--font-mono); transition: all .15s;
  }
  .target-editor-tab.active { color: #fff; border-color: transparent; }
  .target-editor-wrap { background: var(--surface); border-radius: 8px; overflow-x: auto; margin-bottom: 20px; }
  .target-editor-wrap table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .target-editor-wrap th { background: var(--surface2); color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: .07em; padding: 8px 10px; text-align: left; }
  .target-editor-wrap td { padding: 7px 10px; border-bottom: 1px solid var(--border); }
  .target-input {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 4px;
    color: #ffe566; font-family: var(--font-mono); font-size: 12px;
    padding: 4px 8px; width: 120px; outline: none; transition: border-color .15s;
  }
  .target-input:focus { border-color: var(--amber); }
  .target-input.modified { border-color: var(--amber); color: var(--amber); }
  .target-reset-btn {
    background: transparent; border: 1px solid var(--border); color: var(--muted);
    border-radius: 4px; padding: 3px 8px; font-size: 10px; cursor: pointer;
    font-family: var(--font-mono); transition: all .15s; margin-left: 6px;
  }
  .target-reset-btn:hover { border-color: #e05252; color: #e05252; }
  .eoy-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 18px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  .eoy-item .eoy-label { font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 4px; }
  .eoy-item .eoy-val { font-family: var(--font-head); font-size: 22px; font-weight: 800; }
  .eoy-item .eoy-sub { font-size: 10px; color: var(--muted); margin-top: 3px; }
  @media (max-width: 900px) { .eoy-card { grid-template-columns: repeat(2,1fr); } }

  /* â”€â”€ CLASS BREAKDOWN TABS â”€â”€ */
  .class-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
  .class-tab {
    padding: 5px 12px; border-radius: 5px; font-size: 11px;
    cursor: pointer; border: 1px solid transparent;
    font-family: var(--font-mono); transition: all .15s;
    color: var(--muted); background: var(--surface2);
  }
  .class-tab:hover { color: var(--text); }
  .class-tab.active { color: #fff; border-color: transparent; }

  /* â”€â”€ TEAM SUMMARY â”€â”€ */
  .team-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 18px; }
  .rep-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    position: relative; overflow: hidden;
  }
  .rep-card-name { font-family: var(--font-head); font-size: 15px; font-weight: 700; margin-bottom: 2px; }
  .rep-card-region { font-size: 10px; color: var(--muted); margin-bottom: 12px; }
  .rep-card-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .rep-stat-label { font-size: 10px; color: var(--muted); margin-bottom: 2px; }
  .rep-stat-val { font-family: var(--font-head); font-size: 14px; font-weight: 700; }
  .progress-bar-wrap { margin-top: 10px; }
  .progress-bar-bg { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 2px; transition: width .4s ease; }
  .progress-label { font-size: 10px; color: var(--muted); margin-top: 4px; display: flex; justify-content: space-between; }

  /* â”€â”€ PLANNER â”€â”€ */
  .planner-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .planner-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px; padding: 14px 16px;
  }
  .planner-card .planner-label { font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 6px; }
  .planner-card .planner-val { font-family: var(--font-head); font-size: 20px; font-weight: 800; }

  /* Responsive */
  @media (max-width: 900px) {
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
    .growth-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-row { grid-template-columns: 1fr; }
    .team-grid { grid-template-columns: 1fr; }
    .planner-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 560px) {
    .topbar { flex-direction: column; height: auto; padding: 10px; gap: 8px; }
    .topbar-tabs { flex-wrap: wrap; justify-content: center; }
    .kpi-row { grid-template-columns: 1fr 1fr; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--faint); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* â”€â”€ LOGIN SCREEN â”€â”€ */
  #login-screen {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  .login-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 40px 44px;
    width: 100%; max-width: 400px;
    box-shadow: 0 8px 40px rgba(0,0,0,.6);
  }
  .login-logo {
    display: flex; align-items: center; gap: 12px;
    font-family: var(--font-head); font-weight: 800; font-size: 20px;
    color: var(--green); margin-bottom: 28px;
  }
  .login-title { font-family: var(--font-head); font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .login-subtitle { font-size: 11px; color: var(--muted); margin-bottom: 28px; }
  .login-field { margin-bottom: 16px; }
  .login-field label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 6px; }
  .login-field input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 6px; padding: 10px 12px; color: var(--text);
    font-family: var(--font-mono); font-size: 13px; outline: none;
    transition: border-color .15s;
  }
  .login-field input:focus { border-color: var(--green); }
  .login-btn {
    width: 100%; background: var(--green); color: #000; border: none;
    border-radius: 6px; padding: 11px; font-family: var(--font-head);
    font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px;
    transition: opacity .15s;
  }
  .login-btn:hover { opacity: .85; }
  .login-error { color: #e05252; font-size: 11px; margin-top: 10px; min-height: 16px; text-align: center; }
</style>
</head>
<body>

<!-- â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <svg width="32" height="32" viewBox="0 0 28 28" fill="none">
        <rect width="28" height="28" rx="6" fill="#6bbf33"/>
        <text x="14" y="20" text-anchor="middle" font-family="Syne,sans-serif" font-weight="800" font-size="14" fill="white">SE</text>
      </svg>
      SERVEREDGE
    </div>
    <div class="login-title">FY2026 Sales Dashboard</div>
    <div class="login-subtitle">Sign in with your Serveredge email to continue</div>
    <div class="login-field">
      <label>Email Address</label>
      <input type="email" id="login-email" placeholder="you@serveredge.com.au" autocomplete="email">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"
        onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- â”€â”€ TOP NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="topbar">
  <div class="topbar-logo">
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
      <rect width="28" height="28" rx="6" fill="#6bbf33"/>
      <text x="14" y="20" text-anchor="middle" font-family="Syne,sans-serif" font-weight="800" font-size="14" fill="white">SE</text>
    </svg>
    SERVEREDGE
    <span>FY2026 Sales Dashboard</span>
  </div>
  <div class="topbar-tabs" id="mainTabs">
    <button class="tab-btn active" onclick="showView('team')" id="tab-team">
      <span class="dot" style="background:#6bbf33"></span>Team Overview
    </button>
    <button class="tab-btn" onclick="showView('rep-0')" id="tab-rep-0">
      <span class="dot" style="background:#4472c4"></span>Robert Schaffer
    </button>
    <button class="tab-btn" onclick="showView('rep-1')" id="tab-rep-1">
      <span class="dot" style="background:#70ad47"></span>Andrew Mobilia
    </button>
    <button class="tab-btn" onclick="showView('rep-2')" id="tab-rep-2">
      <span class="dot" style="background:#ed7d31"></span>Alexander Poll
    </button>
    <button class="tab-btn" onclick="showView('rep-3')" id="tab-rep-3">
      <span class="dot" style="background:#9e480e"></span>Stivi Maticevski
    </button>
    <button class="tab-btn" onclick="showView('bulk')" id="tab-bulk">
      <span class="dot" style="background:#f5a623"></span>Bulk Entry
    </button>
    <span id="sync-indicator" style="font-size:11px;color:var(--muted);font-family:var(--font-mono);margin-left:12px">ðŸ”´ Live</span>
    <span id="user-info" style="font-size:11px;color:var(--muted);font-family:var(--font-mono);margin-left:16px"></span>
    <button class="theme-toggle" id="theme-toggle-btn" onclick="toggleTheme()">ðŸŒ™ Dark</button>
    <button id="logout-btn" onclick="doLogout()" style="display:none;margin-left:10px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:5px;padding:4px 10px;font-family:var(--font-mono);font-size:11px;cursor:pointer;" onmouseover="this.style.borderColor='#e05252';this.style.color='#e05252'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">Sign Out</button>
  </div>
</div> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="views-container">
  <!-- Team view and rep views are injected by JS -->
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REPS_DATA = [{"name":"Robert Schaffer","region":"QLD","color":"#4472C4","monthly":[{"month":"Jan","target":242199.0,"prev":201833.0},{"month":"Feb","target":281046.0,"prev":234205.0},{"month":"Mar","target":283538.0,"prev":236282.0},{"month":"Apr","target":270528.0,"prev":225440.0},{"month":"May","target":356245.0,"prev":296871.0},{"month":"Jun","target":359078.0,"prev":299232.0},{"month":"Jul","target":363360.0,"prev":302800.0},{"month":"Aug","target":355187.0,"prev":295989.0},{"month":"Sep","target":311193.0,"prev":259327.0},{"month":"Oct","target":396274.0,"prev":330229.0},{"month":"Nov","target":368121.0,"prev":306767.0},{"month":"Dec","target":244305.0,"prev":203588.0}],"classes":[{"name":"Server Racks & Accessories","color":"#4472C4","monthly":[{"month":"Jan","target":104394.0,"prev":86995.0},{"month":"Feb","target":135713.0,"prev":113094.0},{"month":"Mar","target":136824.0,"prev":114020.0},{"month":"Apr","target":137114.0,"prev":114262.0},{"month":"May","target":179651.0,"prev":149709.0},{"month":"Jun","target":173649.0,"prev":144708.0},{"month":"Jul","target":130406.0,"prev":108672.0},{"month":"Aug","target":181263.0,"prev":151052.0},{"month":"Sep","target":121993.0,"prev":101661.0},{"month":"Oct","target":192590.0,"prev":160491.0},{"month":"Nov","target":156902.0,"prev":130752.0},{"month":"Dec","target":98439.0,"prev":82032.0}]},{"name":"Data Products","color":"#70AD47","monthly":[{"month":"Jan","target":39525.0,"prev":32938.0},{"month":"Feb","target":57540.0,"prev":47950.0},{"month":"Mar","target":48780.0,"prev":40650.0},{"month":"Apr","target":53752.0,"prev":44793.0},{"month":"May","target":45664.0,"prev":38053.0},{"month":"Jun","target":60170.0,"prev":50141.0},{"month":"Jul","target":74173.0,"prev":61810.0},{"month":"Aug","target":52449.0,"prev":43707.0},{"month":"Sep","target":83532.0,"prev":69610.0},{"month":"Oct","target":48783.0,"prev":40652.0},{"month":"Nov","target":62912.0,"prev":52427.0},{"month":"Dec","target":40369.0,"prev":33640.0}]},{"name":"Cabling & Adapters","color":"#ED7D31","monthly":[{"month":"Jan","target":93687.0,"prev":78073.0},{"month":"Feb","target":87629.0,"prev":73024.0},{"month":"Mar","target":93806.0,"prev":78172.0},{"month":"Apr","target":78055.0,"prev":65045.0},{"month":"May","target":120817.0,"prev":100681.0},{"month":"Jun","target":124805.0,"prev":104004.0},{"month":"Jul","target":146835.0,"prev":122363.0},{"month":"Aug","target":139019.0,"prev":115849.0},{"month":"Sep","target":93498.0,"prev":77915.0},{"month":"Oct","target":137601.0,"prev":114667.0},{"month":"Nov","target":130545.0,"prev":108788.0},{"month":"Dec","target":95056.0,"prev":79213.0}]},{"name":"Others","color":"#9E480E","monthly":[{"month":"Jan","target":4594.0,"prev":3828.0},{"month":"Feb","target":163.0,"prev":136.0},{"month":"Mar","target":4129.0,"prev":3440.0},{"month":"Apr","target":1607.0,"prev":1339.0},{"month":"May","target":10113.0,"prev":8427.0},{"month":"Jun","target":455.0,"prev":379.0},{"month":"Jul","target":11946.0,"prev":9955.0},{"month":"Aug","target":-17543.0,"prev":-14619.0},{"month":"Sep","target":12169.0,"prev":10140.0},{"month":"Oct","target":17301.0,"prev":14418.0},{"month":"Nov","target":17761.0,"prev":14801.0},{"month":"Dec","target":10442.0,"prev":8702.0}]}],"growthRates":[20,20,20,20]},{"name":"Andrew Mobilia","region":"NSW Â· NT Â· QLD Â· SA Â· VIC Â· WA","color":"#70AD47","monthly":[{"month":"Jan","target":280863.0,"prev":234053.0},{"month":"Feb","target":310113.0,"prev":258428.0},{"month":"Mar","target":314945.0,"prev":262454.0},{"month":"Apr","target":252459.0,"prev":210383.0},{"month":"May","target":300914.0,"prev":250762.0},{"month":"Jun","target":254833.0,"prev":212360.0},{"month":"Jul","target":605780.0,"prev":504817.0},{"month":"Aug","target":445496.0,"prev":371247.0},{"month":"Sep","target":481246.0,"prev":401039.0},{"month":"Oct","target":509776.0,"prev":424814.0},{"month":"Nov","target":462433.0,"prev":385361.0},{"month":"Dec","target":295537.0,"prev":246281.0}],"classes":[{"name":"Server Racks & Accessories","color":"#4472C4","monthly":[{"month":"Jan","target":167472.0,"prev":139560.0},{"month":"Feb","target":138903.0,"prev":115752.0},{"month":"Mar","target":190966.0,"prev":159139.0},{"month":"Apr","target":150350.0,"prev":125292.0},{"month":"May","target":222249.0,"prev":185208.0},{"month":"Jun","target":163059.0,"prev":135883.0},{"month":"Jul","target":253014.0,"prev":210845.0},{"month":"Aug","target":301330.0,"prev":251108.0},{"month":"Sep","target":336099.0,"prev":280083.0},{"month":"Oct","target":288294.0,"prev":240245.0},{"month":"Nov","target":274837.0,"prev":229031.0},{"month":"Dec","target":167942.0,"prev":139952.0}]},{"name":"Data Products","color":"#70AD47","monthly":[{"month":"Jan","target":31849.0,"prev":26541.0},{"month":"Feb","target":37340.0,"prev":31117.0},{"month":"Mar","target":25321.0,"prev":21101.0},{"month":"Apr","target":28617.0,"prev":23847.0},{"month":"May","target":32836.0,"prev":27364.0},{"month":"Jun","target":41334.0,"prev":34445.0},{"month":"Jul","target":142985.0,"prev":119154.0},{"month":"Aug","target":51101.0,"prev":42584.0},{"month":"Sep","target":44360.0,"prev":36967.0},{"month":"Oct","target":100144.0,"prev":83453.0},{"month":"Nov","target":54506.0,"prev":45422.0},{"month":"Dec","target":33940.0,"prev":28284.0}]},{"name":"Cabling & Adapters","color":"#ED7D31","monthly":[{"month":"Jan","target":77275.0,"prev":64396.0},{"month":"Feb","target":115022.0,"prev":95852.0},{"month":"Mar","target":77660.0,"prev":64717.0},{"month":"Apr","target":66297.0,"prev":55248.0},{"month":"May","target":118422.0,"prev":98685.0},{"month":"Jun","target":85928.0,"prev":71607.0},{"month":"Jul","target":191476.0,"prev":159563.0},{"month":"Aug","target":161244.0,"prev":134370.0},{"month":"Sep","target":124363.0,"prev":103636.0},{"month":"Oct","target":142632.0,"prev":118860.0},{"month":"Nov","target":143542.0,"prev":119618.0},{"month":"Dec","target":88349.0,"prev":73624.0}]},{"name":"Others","color":"#9E480E","monthly":[{"month":"Jan","target":4268.0,"prev":3557.0},{"month":"Feb","target":18849.0,"prev":15707.0},{"month":"Mar","target":20997.0,"prev":17498.0},{"month":"Apr","target":7195.0,"prev":5996.0},{"month":"May","target":-72593.0,"prev":-60494.0},{"month":"Jun","target":-35489.0,"prev":-29574.0},{"month":"Jul","target":18305.0,"prev":15254.0},{"month":"Aug","target":-68179.0,"prev":-56816.0},{"month":"Sep","target":-23576.0,"prev":-19647.0},{"month":"Oct","target":-21294.0,"prev":-17745.0},{"month":"Nov","target":-10452.0,"prev":-8710.0},{"month":"Dec","target":5305.0,"prev":4421.0}]}],"growthRates":[20,20,20,20]},{"name":"Alexander Poll","region":"NSW Â· QLD Â· VIC","color":"#ED7D31","monthly":[{"month":"Jan","target":90191.0,"prev":75159.0},{"month":"Feb","target":140273.0,"prev":116895.0},{"month":"Mar","target":129305.0,"prev":107754.0},{"month":"Apr","target":130584.0,"prev":108820.0},{"month":"May","target":121025.0,"prev":100854.0},{"month":"Jun","target":130160.0,"prev":108467.0},{"month":"Jul","target":140102.0,"prev":116752.0},{"month":"Aug","target":153258.0,"prev":127715.0},{"month":"Sep","target":195038.0,"prev":162531.0},{"month":"Oct","target":139353.0,"prev":116128.0},{"month":"Nov","target":177893.0,"prev":148244.0},{"month":"Dec","target":120402.0,"prev":100335.0}],"classes":[{"name":"Server Racks & Accessories","color":"#4472C4","monthly":[{"month":"Jan","target":26539.0,"prev":22116.0},{"month":"Feb","target":52783.0,"prev":43986.0},{"month":"Mar","target":43126.0,"prev":35938.0},{"month":"Apr","target":40881.0,"prev":34067.0},{"month":"May","target":48308.0,"prev":40257.0},{"month":"Jun","target":49426.0,"prev":41188.0},{"month":"Jul","target":53995.0,"prev":44996.0},{"month":"Aug","target":68944.0,"prev":57453.0},{"month":"Sep","target":52876.0,"prev":44064.0},{"month":"Oct","target":58535.0,"prev":48779.0},{"month":"Nov","target":62824.0,"prev":52353.0},{"month":"Dec","target":55871.0,"prev":46559.0}]},{"name":"Data Products","color":"#70AD47","monthly":[{"month":"Jan","target":30633.0,"prev":25527.0},{"month":"Feb","target":28443.0,"prev":23703.0},{"month":"Mar","target":27260.0,"prev":22717.0},{"month":"Apr","target":38833.0,"prev":32361.0},{"month":"May","target":34280.0,"prev":28567.0},{"month":"Jun","target":29782.0,"prev":24818.0},{"month":"Jul","target":42644.0,"prev":35536.0},{"month":"Aug","target":23688.0,"prev":19740.0},{"month":"Sep","target":77736.0,"prev":64780.0},{"month":"Oct","target":28518.0,"prev":23765.0},{"month":"Nov","target":37381.0,"prev":31151.0},{"month":"Dec","target":29497.0,"prev":24581.0}]},{"name":"Cabling & Adapters","color":"#ED7D31","monthly":[{"month":"Jan","target":28666.0,"prev":23889.0},{"month":"Feb","target":49539.0,"prev":41283.0},{"month":"Mar","target":52781.0,"prev":43984.0},{"month":"Apr","target":43605.0,"prev":36338.0},{"month":"May","target":31971.0,"prev":26642.0},{"month":"Jun","target":45523.0,"prev":37936.0},{"month":"Jul","target":38739.0,"prev":32282.0},{"month":"Aug","target":53323.0,"prev":44436.0},{"month":"Sep","target":56598.0,"prev":47165.0},{"month":"Oct","target":47638.0,"prev":39699.0},{"month":"Nov","target":74021.0,"prev":61684.0},{"month":"Dec","target":31626.0,"prev":26355.0}]},{"name":"Others","color":"#9E480E","monthly":[{"month":"Jan","target":4353.0,"prev":3628.0},{"month":"Feb","target":9508.0,"prev":7923.0},{"month":"Mar","target":6137.0,"prev":5114.0},{"month":"Apr","target":7265.0,"prev":6054.0},{"month":"May","target":6466.0,"prev":5388.0},{"month":"Jun","target":5429.0,"prev":4525.0},{"month":"Jul","target":4725.0,"prev":3938.0},{"month":"Aug","target":7302.0,"prev":6085.0},{"month":"Sep","target":7828.0,"prev":6524.0},{"month":"Oct","target":4662.0,"prev":3885.0},{"month":"Nov","target":3667.0,"prev":3056.0},{"month":"Dec","target":3408.0,"prev":2840.0}]}],"growthRates":[20,20,20,20]},{"name":"Stivi Maticevski","region":"ACT Â· NSW Â· QLD","color":"#9E480E","monthly":[{"month":"Jan","target":122343.0,"prev":101953.0},{"month":"Feb","target":164323.0,"prev":136936.0},{"month":"Mar","target":152631.0,"prev":127193.0},{"month":"Apr","target":152256.0,"prev":126880.0},{"month":"May","target":23553.0,"prev":19627.0},{"month":"Jun","target":114056.0,"prev":95046.0},{"month":"Jul","target":183562.0,"prev":152968.0},{"month":"Aug","target":-35187.0,"prev":-29322.0},{"month":"Sep","target":148615.0,"prev":123846.0},{"month":"Oct","target":131747.0,"prev":109790.0},{"month":"Nov","target":143638.0,"prev":119698.0},{"month":"Dec","target":158212.0,"prev":131843.0}],"classes":[{"name":"Server Racks & Accessories","color":"#4472C4","monthly":[{"month":"Jan","target":49595.0,"prev":41329.0},{"month":"Feb","target":58259.0,"prev":48549.0},{"month":"Mar","target":72076.0,"prev":60064.0},{"month":"Apr","target":50388.0,"prev":41990.0},{"month":"May","target":103494.0,"prev":86245.0},{"month":"Jun","target":104231.0,"prev":86859.0},{"month":"Jul","target":81310.0,"prev":67758.0},{"month":"Aug","target":56229.0,"prev":46858.0},{"month":"Sep","target":79065.0,"prev":65888.0},{"month":"Oct","target":75221.0,"prev":62684.0},{"month":"Nov","target":80040.0,"prev":66700.0},{"month":"Dec","target":59170.0,"prev":49308.0}]},{"name":"Data Products","color":"#70AD47","monthly":[{"month":"Jan","target":38576.0,"prev":32147.0},{"month":"Feb","target":31420.0,"prev":26183.0},{"month":"Mar","target":20263.0,"prev":16886.0},{"month":"Apr","target":58273.0,"prev":48560.0},{"month":"May","target":48827.0,"prev":40690.0},{"month":"Jun","target":24133.0,"prev":20111.0},{"month":"Jul","target":31814.0,"prev":26511.0},{"month":"Aug","target":25146.0,"prev":20955.0},{"month":"Sep","target":26351.0,"prev":21959.0},{"month":"Oct","target":34089.0,"prev":28407.0},{"month":"Nov","target":22789.0,"prev":18991.0},{"month":"Dec","target":35656.0,"prev":29713.0}]},{"name":"Cabling & Adapters","color":"#ED7D31","monthly":[{"month":"Jan","target":28004.0,"prev":23336.0},{"month":"Feb","target":40183.0,"prev":33486.0},{"month":"Mar","target":54213.0,"prev":45177.0},{"month":"Apr","target":36640.0,"prev":30533.0},{"month":"May","target":35900.0,"prev":29916.0},{"month":"Jun","target":29712.0,"prev":24760.0},{"month":"Jul","target":61610.0,"prev":51341.0},{"month":"Aug","target":27781.0,"prev":23151.0},{"month":"Sep","target":65117.0,"prev":54265.0},{"month":"Oct","target":44074.0,"prev":36728.0},{"month":"Nov","target":61245.0,"prev":51038.0},{"month":"Dec","target":53957.0,"prev":44964.0}]},{"name":"Others","color":"#9E480E","monthly":[{"month":"Jan","target":6169.0,"prev":5140.0},{"month":"Feb","target":34460.0,"prev":28717.0},{"month":"Mar","target":6079.0,"prev":5066.0},{"month":"Apr","target":6956.0,"prev":5797.0},{"month":"May","target":-164668.0,"prev":-137224.0},{"month":"Jun","target":-44020.0,"prev":-36684.0},{"month":"Jul","target":8829.0,"prev":7357.0},{"month":"Aug","target":-144343.0,"prev":-120286.0},{"month":"Sep","target":-21918.0,"prev":-18265.0},{"month":"Oct","target":-21636.0,"prev":-18030.0},{"month":"Nov","target":-20437.0,"prev":-17031.0},{"month":"Dec","target":9430.0,"prev":7858.0}]}],"growthRates":[20,20,20,20]}];

// State: actuals keyed by repIndex-monthIndex and classIndex
const state = {
  actuals: {},         // "repIdx-monthIdx" -> value
  classActuals: {},    // "repIdx-clsIdx-monthIdx" -> value
  customTargets: {},   // "repIdx-clsIdx-monthIdx" -> value (admin overrides)
  growthRates: REPS_DATA.map(r => [...r.growthRates]), // kept for legacy
};

// â”€â”€ Firebase persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH & ACCESS CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Define who is admin and which rep each email maps to
const ADMIN_EMAILS = ['pkumar@serveredge.com.au', 'puberoi@serveredge.com.au'];
const REP_EMAIL_MAP = {
  'rschaffer@serveredge.com.au': 0,
  'amobilia@serveredge.com.au':  1,
  'apoll@serveredge.com.au':     2,
  'smaticevski@serveredge.com.au': 3,
};

function getCurrentUserRole() {
  const email = window._currentUser?.email?.toLowerCase();
  if (!email) return null;
  if (ADMIN_EMAILS.includes(email)) return { role: 'admin', repIdx: null };
  const repIdx = REP_EMAIL_MAP[email];
  if (repIdx !== undefined) return { role: 'rep', repIdx };
  return null;
}

function applyAccessControl() {
  const access = getCurrentUserRole();
  if (!access) return;

  const tabs = document.getElementById('mainTabs');
  if (!tabs) return;

  if (access.role === 'admin') {
    tabs.querySelectorAll('.tab-btn').forEach(b => b.style.display = '');
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
  } else {
    tabs.querySelectorAll('.tab-btn').forEach(b => b.style.display = 'none');
    const myTab = document.getElementById(`tab-rep-${access.repIdx}`);
    if (myTab) myTab.style.display = '';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    showView(`rep-${access.repIdx}`);
  }
}

// â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const btn = document.getElementById('theme-toggle-btn');
  if (btn) btn.textContent = isLight ? 'ðŸŒ™ Dark' : 'â˜€ï¸ Light';
  localStorage.setItem('se-theme', isLight ? 'light' : 'dark');
}

// Apply saved theme on load
(function() {
  const saved = localStorage.getItem('se-theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    // Update button once DOM ready
    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('theme-toggle-btn');
      if (btn) btn.textContent = 'ðŸŒ™ Dark';
    });
  }
})();

function doLogin() {
  const email    = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl    = document.getElementById('login-error');
  errEl.textContent = '';

  if (!email || !password) { errEl.textContent = 'Please enter your email and password.'; return; }
  if (!window._fbLogin)    { errEl.textContent = 'Still connecting, please wait a moment...'; return; }

  const btn = document.querySelector('.login-btn');
  btn.textContent = 'Signing in...'; btn.disabled = true;

  window._fbLogin(email, password)
    .then(() => { /* auth-changed event handles the rest */ })
    .catch(err => {
      btn.textContent = 'Sign In'; btn.disabled = false;
      if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
        errEl.textContent = 'Incorrect email or password. Please try again.';
      } else if (err.code === 'auth/too-many-requests') {
        errEl.textContent = 'Too many failed attempts. Please try again later.';
      } else {
        errEl.textContent = 'Sign in failed. Please check your connection.';
      }
    });
}

function doLogout() {
  if (window._fbLogout) window._fbLogout();
}

// Listen for auth state changes
window.addEventListener('auth-changed', e => {
  const user = e.detail.user;
  if (user) {
    // Hide login screen, show dashboard
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('logout-btn').style.display = '';
    const userInfo = document.getElementById('user-info');
    if (userInfo) userInfo.textContent = 'ðŸ‘¤ ' + user.email;
    applyAccessControl();
    fbStartListening();
  } else {
    // Show login screen, hide dashboard
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('logout-btn').style.display = 'none';
    const userInfo = document.getElementById('user-info');
    if (userInfo) userInfo.textContent = '';
    const btn = document.querySelector('.login-btn');
    if (btn) { btn.textContent = 'Sign In'; btn.disabled = false; }
  }
});

function fbSave() {
  if (!window._fbSet) return;
  window._fbSet('dashboard/classActuals', state.classActuals);
  window._fbSet('dashboard/customTargets', state.customTargets);
}

function fbClear() {
  if (!window._fbRemove) return;
  window._fbRemove('dashboard/classActuals');
  // Don't clear growthRates on data clear â€” targets should persist
}

function fbStartListening() {
  if (!window._fbListen) return;

  // Listen for actuals
  window._fbListen('dashboard/classActuals', data => {
    state.classActuals = data || {};
    populateBulkView();
    REPS_DATA.forEach((_, ri) => {
      const repView = document.getElementById(`view-rep-${ri}`);
      if (repView && repView.classList.contains('active')) {
        populateTracker(ri);
        populateClassTrackers(ri);
        drawRepCharts(ri);
      }
    });
    refreshTeamView();
    showSyncIndicator();
  });

  // Listen for custom targets (admin overrides)
  window._fbListen('dashboard/customTargets', data => {
    state.customTargets = data || {};
    // Refresh target editor UI and all calculations
    REPS_DATA.forEach((_, ri) => {
      populateTargetEditor(ri);
      populateTracker(ri);
      populateClassTrackers(ri);
      drawRepCharts(ri);
    });
    refreshTeamView();
    showSyncIndicator();
  });
}

function showSyncIndicator() {
  let el = document.getElementById('sync-indicator');
  if (!el) return;
  el.textContent = 'âœ… Synced';
  el.style.color = 'var(--green)';
  setTimeout(() => { el.textContent = 'ðŸ”´ Live'; el.style.color = 'var(--muted)'; }, 2000);
}

// Start Firebase listener once ready
// fbStartListening is called from auth-changed event after login

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = (s, ctx = document) => ctx.querySelector(s);
const $$ = (s, ctx = document) => [...ctx.querySelectorAll(s)];
const fmt = v => v == null || isNaN(v) ? 'â€”' : (v < 0 ? '(' : '') + '$' + Math.abs(Math.round(v)).toLocaleString() + (v < 0 ? ')' : '');
const fmtK = v => v == null || isNaN(v) ? 'â€”' : '$' + (Math.round(v / 1000)).toLocaleString() + 'k';
const fmtPct = v => isNaN(v) || !isFinite(v) ? 'â€”' : (v * 100).toFixed(1) + '%';

// â”€â”€ Compute derived targets from growth rates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getClassTarget(repIdx, clsIdx, monthIdx) {
  // Use admin-set custom target if it exists, otherwise fall back to original data
  const custom = state.customTargets[`${repIdx}-${clsIdx}-${monthIdx}`];
  if (custom !== undefined) return custom;
  return REPS_DATA[repIdx].classes[clsIdx].monthly[monthIdx].target;
}
function getTarget(repIdx, monthIdx) {
  // Sum class targets
  return REPS_DATA[repIdx].classes.reduce((sum, _, ci) => sum + getClassTarget(repIdx, ci, monthIdx), 0);
}
function getActual(repIdx, monthIdx) {
  // Sum across all class actuals so Monthly Tracker always reflects class entries
  return REPS_DATA[repIdx].classes.reduce((sum, _, ci) => sum + getClassActual(repIdx, ci, monthIdx), 0);
}
function getClassActual(repIdx, clsIdx, monthIdx) {
  return state.classActuals[`${repIdx}-${clsIdx}-${monthIdx}`] || 0;
}

// â”€â”€ Chart registry (to destroy/recreate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const charts = {};
function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}
function mkChart(id, config) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, config);
  return charts[id];
}

const CHART_DEFAULTS = {
  plugins: { legend: { labels: { color: '#888', font: { family: 'DM Mono', size: 10 }, boxWidth: 10 } } },
  scales: {
    x: { ticks: { color: '#666', font: { family: 'DM Mono', size: 10 } }, grid: { color: '#1e1e1e' } },
    y: { ticks: { color: '#666', font: { family: 'DM Mono', size: 10 }, callback: v => '$' + (v/1000).toFixed(0) + 'k' }, grid: { color: '#1e1e1e' } }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD REP VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRepView(repIdx) {
  const rep = REPS_DATA[repIdx];
  const months = rep.monthly.map(m => m.month);
  const annualTarget = months.reduce((s, _, mi) => s + getTarget(repIdx, mi), 0);
  const annualPrev   = rep.monthly.reduce((s, m) => s + m.prev, 0);
  const ytdActual    = months.reduce((s, _, mi) => s + getActual(repIdx, mi), 0);
  const stillToGo    = Math.max(annualTarget - ytdActual, 0);
  const monthsEntered = months.filter((_, mi) => getActual(repIdx, mi) > 0).length;

  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];

  return `
  <div class="rep-header">
    <div>
      <div class="rep-title" style="color:${rep.color}">${rep.name}</div>
      <div class="rep-subtitle">Region: ${rep.region} &nbsp;Â·&nbsp; All values in Australian Dollars (AUD)</div>
      <div class="rep-accent-bar" style="background:${rep.color}"></div>
    </div>
    <div style="font-size:11px;color:var(--muted);text-align:right">
      FY2026 Sales Tracker<br>
      <span style="color:${rep.color};font-weight:700">${fmtPct(ytdActual / annualTarget)}</span> of annual target
    </div>
  </div>

  <div class="kpi-row">
    <div class="kpi-card" style="--accent-color:${rep.color}">
      <div class="kpi-label">Annual Target</div>
      <div class="kpi-value" style="color:var(--green)" id="kpi-anntgt-${repIdx}">${fmt(annualTarget)}</div>
    </div>
    <div class="kpi-card" style="--accent-color:#888">
      <div class="kpi-label">Achieved FY2025</div>
      <div class="kpi-value" style="color:#6699cc">${fmt(annualPrev)}</div>
    </div>
    <div class="kpi-card" style="--accent-color:var(--amber)">
      <div class="kpi-label">YTD Entered</div>
      <div class="kpi-value" style="color:var(--amber)" id="kpi-ytd-${repIdx}">${fmt(ytdActual)}</div>
    </div>
    <div class="kpi-card" style="--accent-color:#e05252">
      <div class="kpi-label">Still To Go</div>
      <div class="kpi-value" style="color:#e05252" id="kpi-still-${repIdx}">${fmt(stillToGo)}</div>
    </div>
  </div>

  <div class="section-hdr admin-only">ðŸŽ¯ Target Upload â€” bulk update targets via CSV (admin only)</div>
  <div class="admin-only" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:18px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">
      <div>
        <div style="font-size:12px;font-weight:600;margin-bottom:8px">Upload CSV to set targets for ${rep.name}</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:12px;line-height:1.6">
          CSV format: <span style="color:var(--amber)">Month, Class, Target</span><br>
          Month: Janâ€“Dec &nbsp;|&nbsp; Class: Server Racks, Data Products, Cabling, Others
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="background:var(--green);color:#000;border-radius:5px;padding:7px 16px;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-head)">
            ðŸ“‚ Upload CSV
            <input type="file" accept=".csv" style="display:none"
              onchange="const f=this.files[0];if(!f)return;document.getElementById('target-upload-status-${repIdx}').textContent='â³ Importing...';const r=new FileReader();r.onload=e=>applyTargetCsv(e.target.result,${repIdx});r.readAsText(f)">
          </label>
          <button onclick="resetAllCustomTargets(${repIdx})" style="background:transparent;border:1px solid #e05252;color:#e05252;border-radius:5px;padding:7px 14px;font-size:11px;font-family:var(--font-mono);cursor:pointer">â†º Reset to Original</button>
          <button onclick="downloadTargetTemplate(${repIdx})" style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:5px;padding:7px 14px;font-size:11px;font-family:var(--font-mono);cursor:pointer">â¬‡ Download Template</button>
        </div>
        <div id="target-upload-status-${repIdx}" style="font-size:11px;margin-top:10px;color:var(--green)"></div>
      </div>
      <div style="font-size:11px;color:var(--muted);background:var(--surface2);border-radius:6px;padding:12px;font-family:var(--font-mono);line-height:1.8">
        <strong style="color:var(--text)">Example CSV:</strong><br>
        Month,Class,Target<br>
        Jan,Server Racks,120000<br>
        Jan,Data Products,45000<br>
        Jan,Cabling,85000<br>
        Jan,Others,5000<br>
        Feb,Server Racks,135000<br>
        ...
      </div>
    </div>
  </div>

  <div class="section-hdr admin-only">ðŸ”® End of Year Prediction â€” based on current run rate</div>
  <div class="eoy-card admin-only" id="eoy-card-${repIdx}">
    <div class="eoy-item"><div class="eoy-label">EOY Projection</div><div class="eoy-val" style="color:var(--muted);font-size:14px">Enter actuals to see projection</div></div>
  </div>

  <div class="section-hdr">ðŸ“Š Performance Charts â€” FY2026</div>
  <div class="charts-row" id="rep-charts-${repIdx}">
    <div class="chart-card">
      <div class="chart-title">Monthly Target vs Actual</div>
      <div class="chart-wrap"><canvas id="ch-rep-total-${repIdx}"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Target vs Actual by Class</div>
      <div class="chart-wrap"><canvas id="ch-rep-class-${repIdx}"></canvas></div>
    </div>
  </div>

  <div class="section-hdr">ðŸ“‹ Monthly Tracker â€” Auto-summed from Results by Class entries</div>
  <div class="tracker-wrap">
    <table>
      <thead>
        <tr>
          <th>Month</th><th>2026 Target</th><th>2025 Actual</th>
          <th>2026 Actual (Sum of Classes)</th><th>Achievement %</th><th>vs Target ($)</th><th>vs Target (%)</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="tracker-body-${repIdx}">
      </tbody>
      <tfoot>
        <tr class="total-row">
          <td>FULL YEAR TOTAL</td>
          <td id="tot-tgt-${repIdx}"></td>
          <td>${fmt(annualPrev)}</td>
          <td id="tot-act-${repIdx}"></td>
          <td id="tot-ach-${repIdx}"></td>
          <td id="tot-var-${repIdx}"></td>
          <td id="tot-vpct-${repIdx}"></td>
          <td id="tot-stat-${repIdx}"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="section-hdr">ðŸ“¦ Results by Class</div>
  <div class="class-tabs" id="cls-tabs-${repIdx}">
    ${rep.classes.map((cls, ci) => `
    <div class="class-tab ${ci===0?'active':''}"
      style="${ci===0?`background:${clsColors[ci]};color:#fff;`:'color:var(--muted)'}"
      onclick="switchClass(${repIdx},${ci})"
      id="cls-tab-${repIdx}-${ci}">
      ${cls.name}
    </div>`).join('')}
  </div>
  ${rep.classes.map((cls, ci) => `
  <div id="cls-section-${repIdx}-${ci}" style="display:${ci===0?'block':'none'}">
    <div class="tracker-wrap">
      <table>
        <thead>
          <tr>
            <th>Month</th><th>2026 Target</th><th>2025 Actual</th>
            <th>Enter 2026 Actual</th><th>vs Target ($)</th><th>vs Target (%)</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="cls-body-${repIdx}-${ci}"></tbody>
        <tfoot>
          <tr class="total-row">
            <td>${cls.name} TOTAL</td>
            <td id="cls-tot-tgt-${repIdx}-${ci}"></td>
            <td>${fmt(cls.monthly.reduce((s,m)=>s+m.prev,0))}</td>
            <td id="cls-tot-act-${repIdx}-${ci}"></td>
            <td id="cls-tot-var-${repIdx}-${ci}"></td>
            <td id="cls-tot-vpct-${repIdx}-${ci}"></td>
            <td id="cls-tot-stat-${repIdx}-${ci}"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>`).join('')}

  `;
}

// â”€â”€ Populate tracker rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateTracker(repIdx) {
  const rep = REPS_DATA[repIdx];
  const tbody = document.getElementById(`tracker-body-${repIdx}`);
  if (!tbody) return;
  tbody.innerHTML = '';

  // Current month index (0=Jan ... 11=Dec), FY2026
  const now = new Date();
  const currentMi = now.getMonth(); // JS months are 0-indexed, same as our array

  let totTgt = 0, totAct = 0, totPrev = 0;
  rep.monthly.forEach((m, mi) => {
    const tgt  = getTarget(repIdx, mi);
    const act  = getActual(repIdx, mi);
    const vari = act > 0 ? act - tgt : null;
    const vpct = act > 0 && tgt !== 0 ? (act - tgt) / Math.abs(tgt) : null;
    const achPct = act > 0 && tgt > 0 ? act / tgt : null; // achievement %
    totTgt += tgt; totAct += act; totPrev += m.prev;

    const isCurrentMonth = mi === currentMi;
    const rowClass = isCurrentMonth ? 'current-month-row' : '';
    const badge = isCurrentMonth ? '<span class="current-month-badge">â–¶ Now</span>' : '';

    const status = act > 0 ? (act >= tgt ? `<span class="status-on">âœ… On Target</span>` : `<span class="status-off">âš ï¸ Below Target</span>`) : `<span class="status-pend">Pending</span>`;
    const varCell = vari !== null ? `<span class="${vari >= 0 ? 'variance-pos' : 'variance-neg'}">${fmt(vari)}</span>` : 'â€”';
    const pctCell = vpct !== null ? `<span class="${vpct >= 0 ? 'variance-pos' : 'variance-neg'}">${fmtPct(vpct)}</span>` : 'â€”';
    const achCell = achPct !== null ? `<span class="${achPct >= 1 ? 'variance-pos' : achPct >= 0.8 ? '' : 'variance-neg'}" style="${achPct >= 0.8 && achPct < 1 ? 'color:var(--amber)' : ''}">${(achPct * 100).toFixed(1)}%</span>` : 'â€”';

    tbody.innerHTML += `<tr class="${rowClass}">
      <td>${m.month} 2026${badge}</td>
      <td class="target-cell">${fmt(tgt)}</td>
      <td class="prev-cell">${fmt(m.prev)}</td>
      <td><span class="actual-input" style="display:inline-block;width:110px;cursor:default;color:#ffe566">${act > 0 ? fmt(act) : 'â€”'}</span></td>
      <td>${achCell}</td>
      <td>${varCell}</td>
      <td>${pctCell}</td>
      <td>${status}</td>
    </tr>`;
  });

  // Totals
  const totVar = totAct > 0 ? totAct - totTgt : null;
  const totVpct = totAct > 0 && totTgt !== 0 ? (totAct - totTgt) / Math.abs(totTgt) : null;
  document.getElementById(`tot-tgt-${repIdx}`).textContent = fmt(totTgt);
  document.getElementById(`tot-act-${repIdx}`).textContent = fmt(totAct);
  const totAchPct = totAct > 0 && totTgt > 0 ? totAct / totTgt : null;
  const totAchEl = document.getElementById(`tot-ach-${repIdx}`);
  if (totAchEl) totAchEl.innerHTML = totAchPct !== null ? `<span class="${totAchPct>=1?'variance-pos':totAchPct>=0.8?'':'variance-neg'}" style="${totAchPct>=0.8&&totAchPct<1?'color:var(--amber)':''}">${(totAchPct*100).toFixed(1)}%</span>` : 'â€”';
  document.getElementById(`tot-var-${repIdx}`).innerHTML = totVar !== null ? `<span class="${totVar>=0?'variance-pos':'variance-neg'}">${fmt(totVar)}</span>` : 'â€”';
  document.getElementById(`tot-vpct-${repIdx}`).innerHTML = totVpct !== null ? `<span class="${totVpct>=0?'variance-pos':'variance-neg'}">${fmtPct(totVpct)}</span>` : 'â€”';
  const s = totAct > 0 ? (totAct >= totTgt ? `<span class="status-on">âœ… On Target</span>` : `<span class="status-off">âš ï¸ Below Target</span>`) : `<span class="status-pend">Pending</span>`;
  document.getElementById(`tot-stat-${repIdx}`).innerHTML = s;

  // KPI cards
  const kpiYtd = document.getElementById(`kpi-ytd-${repIdx}`);
  const kpiStill = document.getElementById(`kpi-still-${repIdx}`);
  const kpiTgt = document.getElementById(`kpi-anntgt-${repIdx}`);
  if (kpiYtd) kpiYtd.textContent = fmt(totAct);
  if (kpiStill) kpiStill.textContent = fmt(Math.max(totTgt - totAct, 0));
  if (kpiTgt) kpiTgt.textContent = fmt(totTgt);

  populateEoyPrediction(repIdx, totTgt, totAct);
}

function populateClassTrackers(repIdx) {
  const rep = REPS_DATA[repIdx];
  const access = getCurrentUserRole();
  const isAdmin = access && access.role === 'admin';
  const now = new Date();
  const currentMi = now.getMonth();

  rep.classes.forEach((cls, ci) => {
    const tbody = document.getElementById(`cls-body-${repIdx}-${ci}`);
    if (!tbody) return;
    tbody.innerHTML = '';
    let totTgt = 0, totAct = 0;
    cls.monthly.forEach((m, mi) => {
      const tgt  = getClassTarget(repIdx, ci, mi);
      const act  = getClassActual(repIdx, ci, mi);
      const vari = act > 0 ? act - tgt : null;
      const vpct = act > 0 && tgt !== 0 ? (act - tgt) / Math.abs(tgt) : null;
      totTgt += tgt; totAct += act;
      const isCurrentMonth = mi === currentMi;
      const rowClass = isCurrentMonth ? 'current-month-row' : '';
      const badge = isCurrentMonth ? '<span class="current-month-badge">â–¶ Now</span>' : '';
      const status = act > 0 ? (act >= tgt ? `<span class="status-on">âœ… On Target</span>` : `<span class="status-off">âš ï¸ Below Target</span>`) : `<span class="status-pend">Pending</span>`;
      const varCell = vari !== null ? `<span class="${vari>=0?'variance-pos':'variance-neg'}">${fmt(vari)}</span>` : 'â€”';
      const pctCell = vpct !== null ? `<span class="${vpct>=0?'variance-pos':'variance-neg'}">${fmtPct(vpct)}</span>` : 'â€”';

      // Admins can edit, reps see read-only display
      const actualCell = isAdmin
        ? `<input class="actual-input" type="text" inputmode="numeric" placeholder="0"
            value="${act > 0 ? act : ''}"
            onblur="setClassActual(${repIdx},${ci},${mi},parseFloat(this.value.replace(/[^0-9.]/g,''))||0)">`
        : `<span style="color:#ffe566;font-family:var(--font-mono)">${act > 0 ? fmt(act) : 'â€”'}</span>`;

      tbody.innerHTML += `<tr class="${rowClass}">
        <td>${m.month} 2026${badge}</td>
        <td class="target-cell">${fmt(tgt)}</td>
        <td class="prev-cell">${fmt(m.prev)}</td>
        <td>${actualCell}</td>
        <td>${varCell}</td><td>${pctCell}</td><td>${status}</td>
      </tr>`;
    });
    const totVar = totAct > 0 ? totAct - totTgt : null;
    const totVpct = totAct > 0 && totTgt !== 0 ? (totAct - totTgt) / Math.abs(totTgt) : null;
    const el = (id) => document.getElementById(id);
    if (el(`cls-tot-tgt-${repIdx}-${ci}`)) el(`cls-tot-tgt-${repIdx}-${ci}`).textContent = fmt(totTgt);
    if (el(`cls-tot-act-${repIdx}-${ci}`)) el(`cls-tot-act-${repIdx}-${ci}`).textContent = fmt(totAct);
    if (el(`cls-tot-var-${repIdx}-${ci}`)) el(`cls-tot-var-${repIdx}-${ci}`).innerHTML = totVar !== null ? `<span class="${totVar>=0?'variance-pos':'variance-neg'}">${fmt(totVar)}</span>` : 'â€”';
    if (el(`cls-tot-vpct-${repIdx}-${ci}`)) el(`cls-tot-vpct-${repIdx}-${ci}`).innerHTML = totVpct !== null ? `<span class="${totVpct>=0?'variance-pos':'variance-neg'}">${fmtPct(totVpct)}</span>` : 'â€”';
    const s = totAct > 0 ? (totAct >= totTgt ? `<span class="status-on">âœ… On Target</span>` : `<span class="status-off">âš ï¸ Below Target</span>`) : `<span class="status-pend">Pending</span>`;
    if (el(`cls-tot-stat-${repIdx}-${ci}`)) el(`cls-tot-stat-${repIdx}-${ci}`).innerHTML = s;
  });
}

function populateEoyPrediction(repIdx, annTgt, ytdAct) {
  const el = document.getElementById(`eoy-card-${repIdx}`);
  if (!el) return;

  const rep = REPS_DATA[repIdx];
  const monthsWithData = rep.monthly.filter((_, mi) => getActual(repIdx, mi) > 0).length;

  if (monthsWithData === 0) {
    el.innerHTML = `<div class="eoy-item"><div class="eoy-label">End of Year Prediction</div><div class="eoy-val" style="color:var(--muted);font-size:14px">Enter actuals to see projection</div></div>`;
    return;
  }

  // â”€â”€ Seasonality from last year â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Use each month's prev (last year actual) to get the seasonal weight
  const prevTotals = rep.monthly.map((m, mi) => {
    // Sum prev across all classes for this month
    return rep.classes.reduce((s, cls) => s + (cls.monthly[mi]?.prev || 0), 0);
  });
  const prevAnnualTotal = prevTotals.reduce((s, v) => s + v, 0);
  // Monthly share of last year's total (seasonal weight)
  const seasonalWeights = prevTotals.map(v => prevAnnualTotal > 0 ? v / prevAnnualTotal : 1/12);

  // â”€â”€ Achievement rate on months with data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // For months with actuals, compare actual vs target to get run-rate %
  let achievedTgt = 0, achievedAct = 0;
  rep.monthly.forEach((_, mi) => {
    const act = getActual(repIdx, mi);
    if (act > 0) {
      achievedTgt += getTarget(repIdx, mi);
      achievedAct += act;
    }
  });
  const achievementRate = achievedTgt > 0 ? achievedAct / achievedTgt : 1;

  // â”€â”€ Project remaining months â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // For months without data: projected actual = target for that month Ã— achievement rate
  // Target is already seasonality-adjusted via growth rates, so this correctly
  // applies the run-rate performance to the seasonal shape of remaining months
  let projectedRemaining = 0;
  rep.monthly.forEach((_, mi) => {
    const act = getActual(repIdx, mi);
    if (act === 0) {
      projectedRemaining += getTarget(repIdx, mi) * achievementRate;
    }
  });

  const eoyProjection = ytdAct + projectedRemaining;
  const eoyAchPct = annTgt > 0 ? eoyProjection / annTgt : null;
  const gap = eoyProjection - annTgt;

  const projColor = eoyAchPct >= 1 ? 'var(--green)' : eoyAchPct >= 0.85 ? 'var(--amber)' : '#e05252';
  const gapColor  = gap >= 0 ? 'var(--green)' : '#e05252';
  const gapLabel  = gap >= 0 ? 'â–² Surplus vs Target' : 'â–¼ Shortfall vs Target';
  const verdict   = eoyAchPct >= 1    ? 'ðŸŸ¢ On track to hit target'
                  : eoyAchPct >= 0.85 ? 'ðŸŸ¡ Close â€” push required in remaining months'
                  : 'ðŸ”´ Significant gap â€” urgent attention needed';

  const monthsRemaining = 12 - monthsWithData;
  const achRatePct = (achievementRate * 100).toFixed(1);

  el.innerHTML = `
    <div class="eoy-item">
      <div class="eoy-label">ðŸ“ˆ EOY Projection</div>
      <div class="eoy-val" style="color:${projColor}">${fmt(eoyProjection)}</div>
      <div class="eoy-sub">Seasonality-adjusted Â· ${monthsRemaining} month${monthsRemaining!==1?'s':''} remaining</div>
    </div>
    <div class="eoy-item">
      <div class="eoy-label">ðŸŽ¯ Full Year Target</div>
      <div class="eoy-val">${fmt(annTgt)}</div>
      <div class="eoy-sub">Current run rate: ${achRatePct}% of target</div>
    </div>
    <div class="eoy-item">
      <div class="eoy-label">âœ… Projected Achievement</div>
      <div class="eoy-val" style="color:${projColor}">${eoyAchPct !== null ? (eoyAchPct*100).toFixed(1)+'%' : 'â€”'}</div>
      <div class="eoy-sub">${verdict}</div>
    </div>
    <div class="eoy-item">
      <div class="eoy-label">${gapLabel}</div>
      <div class="eoy-val" style="color:${gapColor}">${fmt(Math.abs(gap))}</div>
      <div class="eoy-sub">${gap >= 0 ? 'Ahead of full year target' : 'Still needed to hit full year target'}</div>
    </div>
  `;
}

// â”€â”€ Target Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTargetCsv(text, repIdx) {
  const access = getCurrentUserRole();
  if (!access || access.role !== 'admin') return;
  const lines = text.trim().split('\n').slice(1); // skip header
  const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  const clsMap = {
    'server racks': 0, 'server racks & accessories': 0,
    'data products': 1,
    'cabling': 2, 'cabling & adapters': 2,
    'others': 3, 'other': 3
  };
  let count = 0;
  lines.forEach(line => {
    const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g,''));
    if (cols.length < 3) return;
    const monthStr = cols[0].toLowerCase().substring(0,3);
    const clsStr   = cols[1].toLowerCase();
    const val      = parseFloat(cols[2].replace(/[^0-9.-]/g,''));
    const mi = months.indexOf(monthStr);
    const ci = clsMap[clsStr];
    if (mi === -1 || ci === undefined || isNaN(val)) return;
    state.customTargets[`${repIdx}-${ci}-${mi}`] = val;
    count++;
  });
  if (count > 0) {
    fbSave();
    REPS_DATA.forEach((_, ri) => {
      populateTracker(ri);
      populateClassTrackers(ri);
      drawRepCharts(ri);
    });
    refreshTeamView();
    document.getElementById(`target-upload-status-${repIdx}`).textContent = `âœ… Imported ${count} target overrides`;
  } else {
    document.getElementById(`target-upload-status-${repIdx}`).textContent = `âŒ No valid rows found â€” check format`;
  }
}

function resetAllCustomTargets(repIdx) {
  const access = getCurrentUserRole();
  if (!access || access.role !== 'admin') return;
  if (!confirm(`Reset ALL custom targets for ${REPS_DATA[repIdx].name} back to original values?`)) return;
  REPS_DATA[repIdx].classes.forEach((_, ci) => {
    for (let mi = 0; mi < 12; mi++) delete state.customTargets[`${repIdx}-${ci}-${mi}`];
  });
  fbSave();
  populateTracker(repIdx);
  populateClassTrackers(repIdx);
  drawRepCharts(repIdx);
  refreshTeamView();
  document.getElementById(`target-upload-status-${repIdx}`).textContent = `â†º Targets reset to original`;
}

// â”€â”€ Draw charts for a rep â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawRepCharts(repIdx) {
  const rep = REPS_DATA[repIdx];
  const months = rep.monthly.map(m => m.month);
  const targets = months.map((_, mi) => Math.round(getTarget(repIdx, mi)));
  const actuals = months.map((_, mi) => { const a = getActual(repIdx, mi); return a > 0 ? Math.round(a) : null; });
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
  const now = new Date();
  const currentMi = now.getMonth();

  // â”€â”€ Chart 1: Monthly total â€” Target vs Actual line chart â”€â”€
  mkChart(`ch-rep-total-${repIdx}`, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        {
          label: '2026 Target',
          data: targets,
          borderColor: rep.color,
          backgroundColor: rep.color + '18',
          borderWidth: 2.5,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
        },
        {
          label: 'Actual',
          data: actuals,
          borderColor: '#f5a623',
          backgroundColor: '#f5a62320',
          borderWidth: 2.5,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          fill: true,
          spanGaps: false,
        }
      ]
    },
    options: {
      ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        annotation: undefined,
        tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y?.toLocaleString() ?? 'No data'}` } }
      },
      scales: {
        x: { ...CHART_DEFAULTS.scales?.x },
        y: { ...CHART_DEFAULTS.scales?.y, ticks: { callback: v => '$' + (Math.abs(v) >= 1000 ? (v/1000).toFixed(0)+'k' : v) } }
      }
    }
  });

  // â”€â”€ Chart 2: Class-wise YTD â€” Target vs Actual line chart â”€â”€
  const clsDatasets = rep.classes.map((cls, ci) => {
    const tgtData = months.map((_, mi) => Math.round(getClassTarget(repIdx, ci, mi)));
    const actData = months.map((_, mi) => { const a = getClassActual(repIdx, ci, mi); return a > 0 ? Math.round(a) : null; });
    return [
      {
        label: `${cls.name} Target`,
        data: tgtData,
        borderColor: clsColors[ci],
        backgroundColor: 'transparent',
        borderWidth: 2,
        borderDash: [5, 3],
        tension: 0.4,
        pointRadius: 3,
        fill: false,
      },
      {
        label: `${cls.name} Actual`,
        data: actData,
        borderColor: clsColors[ci],
        backgroundColor: clsColors[ci] + '22',
        borderWidth: 2.5,
        tension: 0.4,
        pointRadius: 4,
        fill: false,
        spanGaps: false,
      }
    ];
  }).flat();

  mkChart(`ch-rep-class-${repIdx}`, {
    type: 'line',
    data: { labels: months, datasets: clsDatasets },
    options: {
      ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y?.toLocaleString() ?? 'No data'}` } }
      },
      scales: {
        x: { ...CHART_DEFAULTS.scales?.x },
        y: { ...CHART_DEFAULTS.scales?.y, ticks: { callback: v => '$' + (Math.abs(v) >= 1000 ? (v/1000).toFixed(0)+'k' : v) } }
      }
    }
  });
}

function downloadTargetTemplate(repIdx) {
  const rep = REPS_DATA[repIdx];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const clsNames = ['Server Racks','Data Products','Cabling','Others'];
  let csv = 'Month,Class,Target\n';
  months.forEach((month, mi) => {
    rep.classes.forEach((cls, ci) => {
      const val = Math.round(getClassTarget(repIdx, ci, mi));
      csv += `${month},${clsNames[ci]},${val}\n`;
    });
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${rep.name.replace(' ','_')}_targets_2026.csv`;
  a.click(); URL.revokeObjectURL(url);
}

// â”€â”€ Interactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setActual(repIdx, monthIdx, val) {
  state.actuals[`${repIdx}-${monthIdx}`] = val;
  populateTracker(repIdx);
  drawRepCharts(repIdx);
  refreshTeamView();
}
function setClassActual(repIdx, clsIdx, monthIdx, val) {
  const access = getCurrentUserRole();
  if (!access || access.role !== 'admin') return; // reps cannot edit
  state.classActuals[`${repIdx}-${clsIdx}-${monthIdx}`] = val;
  fbSave();
  populateClassTrackers(repIdx);
  populateTracker(repIdx);
  drawRepCharts(repIdx);
  refreshTeamView();
}
function setGrowth(repIdx, clsIdx, val) {
  // Only admins can adjust growth rates
  const access = getCurrentUserRole();
  if (!access || access.role !== 'admin') return;
  state.growthRates[repIdx][clsIdx] = val;
  const el = document.getElementById(`gval-${repIdx}-${clsIdx}`);
  if (el) el.textContent = val + '%';
  populateTracker(repIdx);
  populateClassTrackers(repIdx);
  drawRepCharts(repIdx);
  refreshTeamView();
  fbSave();
}
function switchClass(repIdx, ci) {
  const rep = REPS_DATA[repIdx];
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
  rep.classes.forEach((_, i) => {
    const tab = document.getElementById(`cls-tab-${repIdx}-${i}`);
    const sec = document.getElementById(`cls-section-${repIdx}-${i}`);
    if (tab) { tab.className = 'class-tab' + (i === ci ? ' active' : ''); tab.style.cssText = i === ci ? `background:${clsColors[i]};color:#fff` : 'color:var(--muted)'; }
    if (sec) sec.style.display = i === ci ? 'block' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTeamView() {
  const repColors = REPS_DATA.map(r => r.color);
  const months = REPS_DATA[0].monthly.map(m => m.month);
  return `
  <div class="rep-header">
    <div>
      <div class="rep-title" style="color:var(--green)">Team Overview</div>
      <div class="rep-subtitle">FY2026 Â· All Associates Â· Manager View Â· All values in AUD</div>
      <div class="rep-accent-bar" style="background:var(--green)"></div>
    </div>
    <div style="font-size:11px;color:var(--muted)">Live from individual rep entries</div>
  </div>

  <div class="section-hdr">ðŸ“Š Team Summary Cards</div>
  <div class="team-grid" id="team-cards"></div>

  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-title">Annual Target vs FY2025 by Associate</div>
      <div class="chart-wrap tall"><canvas id="ch-team-bar"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Class Mix â€” 2025 Revenue</div>
      <div class="chart-wrap tall"><canvas id="ch-team-cls"></canvas></div>
    </div>
    <div class="chart-card wide">
      <div class="chart-title">Monthly Team Revenue â€” FY2025 (All Associates)</div>
      <div class="chart-wrap tall"><canvas id="ch-team-monthly"></canvas></div>
    </div>
  </div>

  <div class="section-hdr">ðŸ“‹ Monthly Team Performance Table</div>
  <div class="tracker-wrap">
    <table>
      <thead>
        <tr>
          <th>Month</th>
          ${REPS_DATA.map(r => `<th>${r.name.split(' ')[0]}</th>`).join('')}
          <th>Team Total</th>
          <th>vs Team Target</th>
        </tr>
      </thead>
      <tbody id="team-monthly-body"></tbody>
      <tfoot>
        <tr class="total-row">
          <td>TOTAL FY2026</td>
          ${REPS_DATA.map((_, ri) => `<td id="team-tot-${ri}"></td>`).join('')}
          <td id="team-tot-all"></td>
          <td id="team-tot-var"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="section-hdr">ðŸ“¦ Results by Class (Team)</div>
  <div class="tracker-wrap">
    <table>
      <thead>
        <tr>
          <th>Class</th>
          ${REPS_DATA.map(r => `<th>${r.name.split(' ')[0]}</th>`).join('')}
          <th>Team Total</th>
        </tr>
      </thead>
      <tbody id="team-class-body"></tbody>
    </table>
  </div>
  `;
}

function refreshTeamView() {
  const teamView = document.getElementById('view-team');
  if (!teamView || !teamView.classList.contains('active')) return;

  // Team cards
  const cardsEl = document.getElementById('team-cards');
  if (cardsEl) {
    cardsEl.innerHTML = REPS_DATA.map((rep, ri) => {
      const annTgt = REPS_DATA[ri].monthly.reduce((s, _, mi) => s + getTarget(ri, mi), 0);
      const annPrev = rep.monthly.reduce((s, m) => s + m.prev, 0);
      const ytd = rep.monthly.reduce((s, _, mi) => s + getActual(ri, mi), 0);
      const pct = annTgt > 0 ? ytd / annTgt : 0;
      return `<div class="rep-card">
        <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${rep.color};border-radius:8px 8px 0 0"></div>
        <div class="rep-card-name" style="color:${rep.color}">${rep.name}</div>
        <div class="rep-card-region">Region: ${rep.region}</div>
        <div class="rep-card-stats">
          <div><div class="rep-stat-label">2026 Target</div><div class="rep-stat-val" style="color:var(--green)">${fmtK(annTgt)}</div></div>
          <div><div class="rep-stat-label">FY2025</div><div class="rep-stat-val" style="color:#6699cc">${fmtK(annPrev)}</div></div>
          <div><div class="rep-stat-label">YTD Entered</div><div class="rep-stat-val" style="color:var(--amber)">${fmtK(ytd)}</div></div>
        </div>
        <div class="progress-bar-wrap">
          <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${Math.min(pct*100,100)}%;background:${rep.color}"></div></div>
          <div class="progress-label"><span>${fmtPct(pct)} of target</span><span>${fmtK(Math.max(annTgt - ytd, 0))} remaining</span></div>
        </div>
      </div>`;
    }).join('');
  }

  // Monthly table
  const tbody = document.getElementById('team-monthly-body');
  if (tbody) {
    tbody.innerHTML = '';
    const months = REPS_DATA[0].monthly.map(m => m.month);
    let totByRep = REPS_DATA.map(() => 0);
    let totTgtByRep = REPS_DATA.map((_, ri) => REPS_DATA[ri].monthly.reduce((s,_,mi) => s + getTarget(ri,mi), 0));
    months.forEach((m, mi) => {
      const repActs = REPS_DATA.map((_, ri) => getActual(ri, mi));
      const teamTotal = repActs.reduce((s, v) => s + v, 0);
      const teamTgt = REPS_DATA.reduce((s, _, ri) => s + getTarget(ri, mi), 0);
      repActs.forEach((v, ri) => totByRep[ri] += v);
      tbody.innerHTML += `<tr>
        <td>${m} 2026</td>
        ${repActs.map((v, ri) => `<td style="color:${v>0?REPS_DATA[ri].color:'var(--muted)'}">${v > 0 ? fmt(v) : 'â€”'}</td>`).join('')}
        <td style="color:var(--green);font-weight:600">${teamTotal > 0 ? fmt(teamTotal) : 'â€”'}</td>
        <td>${teamTotal > 0 ? `<span class="${teamTotal>=teamTgt?'variance-pos':'variance-neg'}">${fmt(teamTotal-teamTgt)}</span>` : 'â€”'}</td>
      </tr>`;
    });
    REPS_DATA.forEach((_, ri) => {
      const el = document.getElementById(`team-tot-${ri}`);
      if (el) el.textContent = fmt(totByRep[ri]);
    });
    const teamGrandTotal = totByRep.reduce((s, v) => s + v, 0);
    const teamGrandTgt   = totTgtByRep.reduce((s, v) => s + v, 0);
    const te = document.getElementById('team-tot-all');
    const tv = document.getElementById('team-tot-var');
    if (te) te.textContent = fmt(teamGrandTotal);
    if (tv) tv.innerHTML = teamGrandTotal > 0 ? `<span class="${teamGrandTotal>=teamGrandTgt?'variance-pos':'variance-neg'}">${fmt(teamGrandTotal-teamGrandTgt)}</span>` : 'â€”';
  }

  // Class table
  const ctbody = document.getElementById('team-class-body');
  if (ctbody) {
    const clsNames = REPS_DATA[0].classes.map(c => c.name);
    const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
    ctbody.innerHTML = clsNames.map((cls, ci) => {
      const repTots = REPS_DATA.map((_, ri) =>
        REPS_DATA[ri].classes[ci].monthly.reduce((s, _, mi) => s + getClassTarget(ri, ci, mi), 0)
      );
      const teamTotal = repTots.reduce((s, v) => s + v, 0);
      return `<tr>
        <td style="color:${clsColors[ci]};font-weight:600">${cls}</td>
        ${repTots.map(v => `<td class="target-cell">${fmt(v)}</td>`).join('')}
        <td style="color:var(--green);font-weight:700">${fmt(teamTotal)}</td>
      </tr>`;
    }).join('');
  }

  // Charts
  const allMonthlyTgts = REPS_DATA.map((_, ri) => REPS_DATA[ri].monthly.reduce((s,_,mi) => s + getTarget(ri,mi), 0));
  const allMonthlyPrev = REPS_DATA.map(r => r.monthly.reduce((s,m) => s + m.prev, 0));
  mkChart('ch-team-bar', {
    type: 'bar', data: {
      labels: REPS_DATA.map(r => r.name.split(' ')[0]),
      datasets: [
        { label: '2026 Target', data: allMonthlyTgts, backgroundColor: REPS_DATA.map(r => r.color + '99'), borderColor: REPS_DATA.map(r => r.color), borderWidth: 1 },
        { label: 'FY2025', data: allMonthlyPrev, backgroundColor: '#333', borderColor: '#555', borderWidth: 1 }
      ]
    }, options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false, plugins: { ...CHART_DEFAULTS.plugins } }
  });

  // Class pie (team total by class based on 2025)
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
  const clsTotals = REPS_DATA[0].classes.map((_, ci) =>
    REPS_DATA.reduce((s, r) => s + r.classes[ci].monthly.reduce((s2, m) => s2 + m.prev, 0), 0)
  );
  mkChart('ch-team-cls', {
    type: 'doughnut', data: {
      labels: REPS_DATA[0].classes.map(c => c.name),
      datasets: [{ data: clsTotals, backgroundColor: clsColors.map(c => c + 'cc'), borderColor: clsColors, borderWidth: 2 }]
    }, options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right', labels: { color: '#888', font: { family: 'DM Mono', size: 10 }, boxWidth: 10 } } }
    }
  });

  // Monthly stacked team
  const months = REPS_DATA[0].monthly.map(m => m.month);
  mkChart('ch-team-monthly', {
    type: 'bar', data: {
      labels: months,
      datasets: REPS_DATA.map((rep, ri) => ({
        label: rep.name.split(' ')[0],
        data: months.map((_, mi) => rep.monthly[mi].prev),
        backgroundColor: rep.color + '99',
        borderColor: rep.color, borderWidth: 1, stack: 'team'
      }))
    }, options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false, plugins: { ...CHART_DEFAULTS.plugins } }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK ENTRY VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildBulkView() {
  const months = REPS_DATA[0].monthly.map(m => m.month);
  const clsNames = REPS_DATA[0].classes.map(c => c.name);
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];

  const csvUploadSection = `
  <div id="csv-upload-panel" style="
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 28px 24px;
    margin-bottom: 24px;
    text-align: center;
    transition: border-color .2s, background .2s;
  " ondragover="event.preventDefault();this.style.borderColor='var(--amber)';this.style.background='rgba(245,166,35,.05)'"
     ondragleave="this.style.borderColor='var(--border)';this.style.background='var(--surface)'"
     ondrop="handleCsvDrop(event)">
    <div style="font-size:28px;margin-bottom:8px">ðŸ“‚</div>
    <div style="font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px">
      Upload your NetSuite CSV export
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:16px">
      Drag & drop your CSV file here, or click to browse.<br>
      All actuals will be parsed and applied to every rep and class automatically.
    </div>
    <input type="file" id="csv-file-input" accept=".csv" style="display:none" onchange="handleCsvFile(this.files[0])">
    <button onclick="document.getElementById('csv-file-input').click()" style="
      background: var(--amber); color: #000; border: none; border-radius: 6px;
      padding: 8px 20px; font-family: var(--font-mono); font-size: 12px;
      font-weight: 600; cursor: pointer; transition: opacity .15s;
    " onmouseover="this.style.opacity='.8'" onmouseout="this.style.opacity='1'">
      Choose CSV File
    </button>
    <button onclick="clearAllData()" style="
      background: transparent; color: #e05252; border: 1px solid #e05252; border-radius: 6px;
      padding: 8px 20px; font-family: var(--font-mono); font-size: 12px;
      font-weight: 600; cursor: pointer; margin-left: 10px; transition: all .15s;
    " onmouseover="this.style.background='rgba(224,82,82,.1)'" onmouseout="this.style.background='transparent'">
      ðŸ—‘ Clear All Data
    </button>
    <div id="csv-status" style="margin-top:14px;font-size:12px;color:var(--muted);min-height:18px"></div>
  </div>`;

  // Build a section per rep, with a tab per class
  const repSections = REPS_DATA.map((rep, ri) => `
    <div style="margin-bottom:28px;">
      <div class="section-hdr"><span style="color:${rep.color}">â— ${rep.name}</span> â€” ${rep.region}</div>
      <div class="class-tabs" id="bulk-cls-tabs-${ri}">
        ${clsNames.map((cls, ci) => `
          <div class="class-tab ${ci===0?'active':''}"
            style="${ci===0?`background:${clsColors[ci]};color:#fff`:'color:var(--muted)'}"
            onclick="switchBulkClass(${ri},${ci})"
            id="bulk-cls-tab-${ri}-${ci}">${cls}</div>
        `).join('')}
      </div>
      ${clsNames.map((cls, ci) => `
        <div id="bulk-cls-section-${ri}-${ci}" style="display:${ci===0?'block':'none'}">
          <div class="tracker-wrap">
            <table>
              <thead>
                <tr>
                  <th>Month</th>
                  <th>2026 Target</th>
                  <th>2025 Actual</th>
                  <th style="color:#ffe566">Enter 2026 Actual</th>
                  <th>vs Target ($)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="bulk-body-${ri}-${ci}"></tbody>
            </table>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');

  return `
  <div class="rep-header">
    <div>
      <div class="rep-title" style="color:var(--amber)">âš¡ Bulk Entry</div>
      <div class="rep-subtitle">Upload a CSV or enter actuals manually Â· Updates all individual sheets instantly</div>
      <div class="rep-accent-bar" style="background:var(--amber)"></div>
    </div>
    <div style="font-size:11px;color:var(--muted);text-align:right">Changes propagate to all rep sheets<br>and the Team Overview automatically</div>
  </div>
  ${csvUploadSection}
  ${repSections}
  `;
}

function populateBulkView() {
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
  const access = getCurrentUserRole();
  const isAdmin = access && access.role === 'admin';

  REPS_DATA.forEach((rep, ri) => {
    rep.classes.forEach((cls, ci) => {
      const tbody = document.getElementById(`bulk-body-${ri}-${ci}`);
      if (!tbody) return;
      tbody.innerHTML = '';
      cls.monthly.forEach((m, mi) => {
        const tgt = getClassTarget(ri, ci, mi);
        const act = getClassActual(ri, ci, mi);
        const vari = act > 0 ? act - tgt : null;
        const varCell = vari !== null ? `<span class="${vari>=0?'variance-pos':'variance-neg'}">${fmt(vari)}</span>` : 'â€”';
        const status = act > 0 ? (act >= tgt ? `<span class="status-on">âœ… On Target</span>` : `<span class="status-off">âš ï¸ Below Target</span>`) : `<span class="status-pend">Pending</span>`;
        const actualCell = isAdmin
          ? `<input class="actual-input" type="text" inputmode="numeric" placeholder="0"
              value="${act > 0 ? act : ''}"
              onblur="setBulkActual(${ri},${ci},${mi},parseFloat(this.value.replace(/[^0-9.]/g,''))||0)">`
          : `<span style="color:#ffe566;font-family:var(--font-mono)">${act > 0 ? fmt(act) : 'â€”'}</span>`;
        tbody.innerHTML += `<tr>
          <td>${m.month} 2026</td>
          <td class="target-cell">${fmt(tgt)}</td>
          <td class="prev-cell">${fmt(m.prev)}</td>
          <td>${actualCell}</td>
          <td>${varCell}</td>
          <td>${status}</td>
        </tr>`;
      });
    });
  });
}

function setBulkActual(repIdx, clsIdx, monthIdx, val) {
  const access = getCurrentUserRole();
  if (!access || access.role !== 'admin') return; // reps cannot edit
  state.classActuals[`${repIdx}-${clsIdx}-${monthIdx}`] = val;
  fbSave();
  populateBulkView();
  REPS_DATA.forEach((_, ri) => {
    const repView = document.getElementById(`view-rep-${ri}`);
    if (repView && repView.classList.contains('active')) {
      populateTracker(ri);
      populateClassTrackers(ri);
      drawRepCharts(ri);
    }
  });
  refreshTeamView();
}

function switchBulkClass(ri, ci) {
  const clsColors = ['#4472C4','#70AD47','#ED7D31','#9E480E'];
  REPS_DATA[ri].classes.forEach((_, i) => {
    const tab = document.getElementById(`bulk-cls-tab-${ri}-${i}`);
    const sec = document.getElementById(`bulk-cls-section-${ri}-${i}`);
    if (tab) { tab.className = 'class-tab' + (i===ci?' active':''); tab.style.cssText = i===ci?`background:${clsColors[i]};color:#fff`:'color:var(--muted)'; }
    if (sec) sec.style.display = i===ci ? 'block' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CSV_REP_MAP = {
  'Robert M Schaffer':  0,
  'Andrew M Mobilia':   1,
  'Alexander Poll':     2,
  'Stivi Maticevski':   3,
};
const CSV_CLASS_MAP = {
  'Server Racks & Accessories': 0,
  'Data Products':               1,
  'Cabling & Adapters':          2,
  // anything else -> 3 (Others)
};
const CSV_MONTH_MAP = {
  '01/01/25':0,'01/02/25':1,'01/03/25':2,'01/04/25':3,
  '01/05/25':4,'01/06/25':5,'01/07/25':6,'01/08/25':7,
  '01/08/25':7,'01/09/25':8,'01/10/25':9,'01/11/25':10,'01/12/25':11,
  '01/01/26':0,'01/02/26':1,'01/03/26':2,'01/04/26':3,
  '01/05/26':4,'01/06/26':5,'01/07/26':6,'01/08/26':7,
  '01/09/26':8,'01/10/26':9,'01/11/26':10,'01/12/26':11,
};

function parseCsvAmount(s) {
  if (!s) return 0;
  s = s.trim();
  const neg = s.startsWith('(');
  s = s.replace(/[($,)\s]/g, '');
  const v = parseFloat(s) || 0;
  return neg ? -v : v;
}

function parseCsv(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  // Find header row
  const headerIdx = lines.findIndex(l => l.includes('Sales Rep') && l.includes('Amount'));
  if (headerIdx < 0) return null;

  const headers = lines[headerIdx].split(',').map(h => h.replace(/^"|"$/g,'').trim());
  const idxRep    = headers.indexOf('Sales Rep');
  const idxPeriod = headers.indexOf('Period');
  const idxClass  = headers.indexOf('Class (no hierarchy)');
  const idxAmt    = headers.indexOf('Amount');

  if ([idxRep,idxPeriod,idxClass,idxAmt].includes(-1)) return null;

  // Accumulate totals: [repIdx][clsIdx][monthIdx]
  const totals = Array.from({length:4}, () =>
    Array.from({length:4}, () => new Array(12).fill(0))
  );

  for (let i = headerIdx + 1; i < lines.length; i++) {
    // Handle quoted fields with commas inside
    const cols = [];
    let cur = '', inQuote = false;
    for (const ch of lines[i]) {
      if (ch === '"') { inQuote = !inQuote; }
      else if (ch === ',' && !inQuote) { cols.push(cur); cur = ''; }
      else cur += ch;
    }
    cols.push(cur);

    const repName  = (cols[idxRep]    || '').trim();
    const period   = (cols[idxPeriod] || '').trim();
    const clsName  = (cols[idxClass]  || '').trim();
    const amt      = parseCsvAmount(cols[idxAmt] || '');

    const ri = CSV_REP_MAP[repName];
    const mi = CSV_MONTH_MAP[period];
    if (ri === undefined || mi === undefined) continue;

    const ci = CSV_CLASS_MAP[clsName] !== undefined ? CSV_CLASS_MAP[clsName] : 3;
    totals[ri][ci][mi] += amt;
  }
  return totals;
}

function applyCsvTotals(totals) {
  // Write into classActuals state
  for (let ri = 0; ri < 4; ri++) {
    for (let ci = 0; ci < 4; ci++) {
      for (let mi = 0; mi < 12; mi++) {
        if (totals[ri][ci][mi] !== 0) {
          state.classActuals[`${ri}-${ci}-${mi}`] = totals[ri][ci][mi];
        }
      }
    }
  }
  // Save to Firebase so all users see the update
  fbSave();
  // Refresh everything
  populateBulkView();
  REPS_DATA.forEach((_, ri) => {
    const repView = document.getElementById(`view-rep-${ri}`);
    if (repView && repView.classList.contains('active')) {
      populateTracker(ri);
      populateClassTrackers(ri);
      drawRepCharts(ri);
    }
  });
  refreshTeamView();
}

function clearAllData() {
  if (!confirm('This will remove all entered actuals and CSV data for everyone. Are you sure?')) return;

  // Clear state and Firebase
  state.actuals = {};
  state.classActuals = {};
  fbClear();

  // Reset upload panel UI
  const panel = document.getElementById('csv-upload-panel');
  if (panel) { panel.style.borderColor = 'var(--border)'; panel.style.background = 'var(--surface)'; }
  const status = document.getElementById('csv-status');
  if (status) { status.style.color = 'var(--green)'; status.textContent = 'âœ… All data cleared for everyone. You can now upload a new CSV.'; }
  const fileInput = document.getElementById('csv-file-input');
  if (fileInput) fileInput.value = '';

  // Refresh all views
  populateBulkView();
  REPS_DATA.forEach((_, ri) => {
    const repView = document.getElementById(`view-rep-${ri}`);
    if (repView && repView.classList.contains('active')) {
      populateTracker(ri);
      populateClassTrackers(ri);
      drawRepCharts(ri);
    }
  });
  refreshTeamView();
}

function handleCsvFile(file) {
  if (!file) return;
  const status = document.getElementById('csv-status');
  status.style.color = 'var(--muted)';
  status.textContent = 'â³ Parsing ' + file.name + '...';
  const reader = new FileReader();
  reader.onload = e => {
    const totals = parseCsv(e.target.result);
    if (!totals) {
      status.style.color = '#e05252';
      status.textContent = 'âŒ Could not parse CSV. Please check the file format matches the NetSuite export.';
      return;
    }
    applyCsvTotals(totals);
    // Count non-zero entries
    let count = 0;
    totals.forEach(r => r.forEach(c => c.forEach(v => { if (v !== 0) count++; })));
    status.style.color = 'var(--green)';
    status.textContent = `âœ… Successfully imported ${file.name} â€” ${count} data points applied across all reps and classes.`;
    // Update panel style
    const panel = document.getElementById('csv-upload-panel');
    if (panel) { panel.style.borderColor = 'var(--green)'; panel.style.background = 'rgba(107,191,51,.04)'; }
  };
  reader.readAsText(file);
}

function handleCsvDrop(event) {
  event.preventDefault();
  const panel = document.getElementById('csv-upload-panel');
  if (panel) { panel.style.borderColor = 'var(--border)'; panel.style.background = 'var(--surface)'; }
  const file = event.dataTransfer.files[0];
  if (file && file.name.endsWith('.csv')) {
    handleCsvFile(file);
  } else {
    const status = document.getElementById('csv-status');
    if (status) { status.style.color = '#e05252'; status.textContent = 'âŒ Please drop a .csv file.'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(id) {
  $$('.view').forEach(v => v.classList.remove('active'));
  $$('.tab-btn').forEach(b => b.classList.remove('active'));
  const view = document.getElementById(`view-${id}`);
  const tab  = document.getElementById(`tab-${id}`);
  if (view) view.classList.add('active');
  if (tab)  tab.classList.add('active');

  if (id === 'team') {
    refreshTeamView();
  } else if (id === 'bulk') {
    populateBulkView();
  } else {
    const repIdx = parseInt(id.split('-')[1]);
    setTimeout(() => {
      populateTracker(repIdx);
      populateClassTrackers(repIdx);
      drawRepCharts(repIdx);
    }, 50);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  const container = document.getElementById('views-container');

  // Team view
  const teamDiv = document.createElement('div');
  teamDiv.id = 'view-team';
  teamDiv.className = 'view active';
  teamDiv.innerHTML = buildTeamView();
  container.appendChild(teamDiv);

  // Rep views
  REPS_DATA.forEach((rep, ri) => {
    const div = document.createElement('div');
    div.id = `view-rep-${ri}`;
    div.className = 'view';
    div.innerHTML = buildRepView(ri);
    container.appendChild(div);
  });

  // Bulk entry view
  const bulkDiv = document.createElement('div');
  bulkDiv.id = 'view-bulk';
  bulkDiv.className = 'view';
  bulkDiv.innerHTML = buildBulkView();
  container.appendChild(bulkDiv);

  // Initial render
  refreshTeamView();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
